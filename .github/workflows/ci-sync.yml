name: CI Sync

# Automatically keeps CI configuration in sync with packages
# Creates PRs when packages are missing from test workflow

on:
  push:
    branches: [main]
    paths:
      - 'packages/*/package.json'
      - 'packages/*/test/**'
  workflow_dispatch:  # Manual trigger

jobs:
  detect-missing:
    name: Detect Missing Tests
    runs-on: ubuntu-latest
    outputs:
      missing: ${{ steps.check.outputs.missing }}
      has_missing: ${{ steps.check.outputs.has_missing }}

    steps:
      - uses: actions/checkout@v4

      - name: Check CI Coverage
        id: check
        run: |
          echo "ğŸ” Checking CI test coverage..."

          # Get all packages
          ALL_PACKAGES=$(ls packages/ | sort)
          echo "All packages: $ALL_PACKAGES"

          # Get packages in CI
          CI_PACKAGES=$(grep -oP '(?<=--workspace=@cynic/)\w+' .github/workflows/ci.yml | sort -u || true)
          echo "CI packages: $CI_PACKAGES"

          # Find missing (packages with test/ dir but not in CI)
          MISSING=""
          for pkg in $ALL_PACKAGES; do
            if [ -d "packages/$pkg/test" ]; then
              if ! echo "$CI_PACKAGES" | grep -q "^${pkg}$"; then
                MISSING="$MISSING $pkg"
              fi
            fi
          done

          MISSING=$(echo $MISSING | xargs)  # Trim whitespace
          echo "Missing from CI: $MISSING"

          if [ -n "$MISSING" ]; then
            echo "missing=$MISSING" >> $GITHUB_OUTPUT
            echo "has_missing=true" >> $GITHUB_OUTPUT
          else
            echo "missing=" >> $GITHUB_OUTPUT
            echo "has_missing=false" >> $GITHUB_OUTPUT
            echo "âœ… All packages with tests are in CI"
          fi

  create-pr:
    name: Create Sync PR
    needs: detect-missing
    if: needs.detect-missing.outputs.has_missing == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Generate CI Updates
        id: generate
        env:
          MISSING: ${{ needs.detect-missing.outputs.missing }}
        run: |
          echo "ğŸ“ Generating CI updates for: $MISSING"

          # Create the test steps to add
          STEPS=""
          for pkg in $MISSING; do
            STEPS="$STEPS
      - name: Run $pkg tests
        run: npm test --workspace=@cynic/$pkg
"
          done

          # Save to file for the PR
          echo "$STEPS" > /tmp/new-test-steps.txt
          cat /tmp/new-test-steps.txt

          # Count packages
          COUNT=$(echo $MISSING | wc -w)
          echo "count=$COUNT" >> $GITHUB_OUTPUT

      - name: Update ci.yml
        env:
          MISSING: ${{ needs.detect-missing.outputs.missing }}
        run: |
          # Find the line number of the last test step in the 'test' job
          # Insert new steps after "Run MCP tests"

          for pkg in $MISSING; do
            # Check if already exists (safety)
            if grep -q "@cynic/$pkg" .github/workflows/ci.yml; then
              echo "âš ï¸ $pkg already in CI, skipping"
              continue
            fi

            # Add after the last npm test line in the test job
            sed -i "/Run MCP tests/a\\
\\
      - name: Run $pkg tests\\
        run: npm test --workspace=@cynic/$pkg" .github/workflows/ci.yml

            echo "âœ… Added $pkg to CI"
          done

          # Show diff
          git diff .github/workflows/ci.yml

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ci: add missing package tests (${{ needs.detect-missing.outputs.missing }})"
          title: "ğŸ¤– CI Sync: Add tests for ${{ needs.detect-missing.outputs.missing }}"
          body: |
            ## ğŸ• Automated CI Sync

            This PR adds missing packages to the CI test workflow.

            ### Packages Added
            ${{ needs.detect-missing.outputs.missing }}

            ### Why
            These packages have `test/` directories but were not included in `.github/workflows/ci.yml`.

            ---
            *Generated by cynic-ci automation*

            > *"Ï† distrusts Ï†"* - ÎºÏ…Î½Î¹ÎºÏŒÏ‚
          branch: ci-sync/${{ github.sha }}
          delete-branch: true
          labels: |
            ci
            automated

  notify:
    name: Notify Status
    needs: [detect-missing, create-pr]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Summary
        env:
          MISSING: ${{ needs.detect-missing.outputs.missing }}
          HAS_MISSING: ${{ needs.detect-missing.outputs.has_missing }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ• CYNIC CI Sync Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          if [ "$HAS_MISSING" = "true" ]; then
            echo "ğŸ“¦ Missing packages detected: $MISSING"
            echo "ğŸ“ PR created to add them to CI"
          else
            echo "âœ… All packages are covered in CI"
          fi

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
