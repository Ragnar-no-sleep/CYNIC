#!/bin/bash
# CYNIC Pre-Commit Hook â€” The Guardian at the Gate
# "Le code se connaÃ®t lui-mÃªme" - ÎºÏ…Î½Î¹ÎºÏŒÏ‚
#
# 1. Validates staged diff (secrets, debug, Ï†-constants)
# 2. Auto-generates README.md for packages with staged changes
#
# Install: npm run hooks:install
#   or: cp scripts/hooks/git/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

ROOT="$(git rev-parse --show-toplevel)"
ERRORS=0

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STAGE 1: GUARDIAN â€” Scan diff for dangers
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DIFF=$(git diff --cached --diff-filter=ACMR -U0 2>/dev/null || true)

if [ -n "$DIFF" ]; then

  # 1a. SECRET DETECTION â€” block API keys, passwords, tokens in code
  SECRET_PATTERNS='(PRIVATE_KEY|SECRET_KEY|API_KEY|api_key|password|passwd|token)\s*[:=]\s*["\x27][^\s]{8,}'
  SECRETS_FOUND=$(echo "$DIFF" | grep -cPi "$SECRET_PATTERNS" 2>/dev/null || echo "0")
  if [ "$SECRETS_FOUND" -gt 0 ]; then
    echo ""
    echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
    echo "â”‚ *GROWL* ðŸ›¡ï¸ GUARDIAN: Possible secrets in staged diff    â”‚"
    echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
    echo "â”‚ Found $SECRETS_FOUND potential secret(s).                       â”‚"
    echo "â”‚ Review with: git diff --cached                         â”‚"
    echo "â”‚ To override: git commit --no-verify                    â”‚"
    echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
    ERRORS=$((ERRORS + 1))
  fi

  # 1b. CONSOLE.LOG / DEBUGGER in production code (not tests, not scripts)
  STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR 2>/dev/null || true)
  PROD_FILES=$(echo "$STAGED_FILES" | grep -E '\.js$|\.mjs$' | grep -v 'test/' | grep -v 'scripts/' | grep -v '__test__' || true)

  if [ -n "$PROD_FILES" ]; then
    DEBUG_COUNT=0
    for f in $PROD_FILES; do
      # Only check added lines (lines starting with +, excluding +++ header)
      FILE_DIFF=$(git diff --cached -U0 "$f" 2>/dev/null | grep "^+" | grep -v "^+++" || true)
      FOUND=$(echo "$FILE_DIFF" | grep -cE '(console\.log|debugger\b)' 2>/dev/null || echo "0")
      DEBUG_COUNT=$((DEBUG_COUNT + FOUND))
    done

    if [ "$DEBUG_COUNT" -gt 0 ]; then
      echo ""
      echo "âš ï¸  Found $DEBUG_COUNT console.log/debugger statement(s) in production code"
      echo "   (tests and scripts are exempt)"
      # Warning only, not blocking
    fi
  fi

  # 1c. Ï† CEILING â€” check that no confidence > 0.618 is hardcoded
  PHI_VIOLATIONS=$(echo "$DIFF" | grep "^+" | grep -v "^+++" | grep -cE 'confidence\s*[:=]\s*(0\.[7-9]|1\.0|0\.6[2-9])' 2>/dev/null || echo "0")
  if [ "$PHI_VIOLATIONS" -gt 0 ]; then
    echo ""
    echo "âš ï¸  Found $PHI_VIOLATIONS confidence value(s) exceeding Ï†â»Â¹ (0.618)"
    echo "   Ï† distrusts Ï† â€” max confidence is 61.8%"
    # Warning only
  fi

fi

# Block on hard errors only (secrets)
if [ "$ERRORS" -gt 0 ]; then
  echo ""
  echo "*GROWL* Commit blocked. Fix issues or use --no-verify to override."
  exit 1
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STAGE 2: DOC HEALTH â€” Detect stale documentation
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CHANGED_DOCS=$(git diff --cached --name-only --diff-filter=ACMR 2>/dev/null | grep -E '^(packages/|scripts/)' || true)
if [ -n "$CHANGED_DOCS" ]; then
  DOC_HEALTH=$(node "$ROOT/scripts/tikkun/doc-health.mjs" --json 2>/dev/null || echo '{}')
  ROTTEN_COUNT=$(echo "$DOC_HEALTH" | grep -o '"rotten":[0-9]*' | grep -o '[0-9]*' || echo "0")
  STALE_COUNT=$(echo "$DOC_HEALTH" | grep -o '"stale":[0-9]*' | grep -o '[0-9]*' || echo "0")

  if [ "$ROTTEN_COUNT" -gt 0 ]; then
    echo ""
    echo "âš ï¸  $ROTTEN_COUNT ROTTEN doc(s) detected â€” run: node scripts/tikkun/doc-health.mjs"
    # Warning only, not blocking
  elif [ "$STALE_COUNT" -gt 0 ]; then
    echo ""
    echo "ðŸ“ $STALE_COUNT stale doc(s) â€” consider updating (node scripts/tikkun/doc-health.mjs)"
  fi
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STAGE 3: AUTO-DOCUMENTATION â€” Keep READMEs alive
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CHANGED_PACKAGES=$(git diff --cached --name-only | grep "^packages/" | cut -d'/' -f2 | sort -u 2>/dev/null || true)

if [ -z "$CHANGED_PACKAGES" ]; then
  exit 0
fi

echo ""
echo "ðŸ§  CYNIC Auto-Documentation"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

for pkg in $CHANGED_PACKAGES; do
  if [ -d "$ROOT/packages/$pkg" ] && [ -f "$ROOT/packages/$pkg/package.json" ]; then
    echo "   ðŸ“¦ $pkg"
    node "$ROOT/scripts/tikkun/auto-document.js" "$pkg" > /dev/null 2>&1 || true
    git add "$ROOT/packages/$pkg/README.md" 2>/dev/null || true
  fi
done

echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "*tail wag* Documentation vivante."
echo ""
exit 0
